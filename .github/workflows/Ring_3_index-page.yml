name: Generate Index Page for Ring_3

on:
  push:
    paths:
      - Ring_3/mods/**

jobs:
  generate-index:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Acquire Lock
        run: |
          while [ -f ".github/LOCK" ]; do
            echo "Waiting for lock to be released..."
            sleep 5
          done
          echo "Lock acquired by Ring_3" > .github/LOCK
          git add .github/LOCK
          git commit -m "Acquire lock for Ring_3"
          git push

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.x

      - name: Install Dependencies
        run: python -m pip install requests

      - name: Generate Index
        run: |
          python <<EOF
          import requests
          import os

          username = "${{ github.repository_owner }}"
          repository = "${{ github.event.repository.name }}"
          directory = "Ring_3/mods"
          branch = "${{ github.ref_name }}"
          api_url = f"https://api.github.com/repos/{username}/{repository}/contents/{directory}?ref={branch}"
          response = requests.get(api_url, headers={"User-Agent": "GitHub-Action"})

          if response.status_code == 200:
              files = response.json()
              html_content = "<!DOCTYPE html>\\n<html>\\n<body>\\n<ul>\\n"
              for file in files:
                  if file['type'] == 'file':
                      html_content += f'<li><a href="{file["name"]}">{file["name"]}</a></li>\\n'
              html_content += "</ul>\\n</body>\\n</html>"
              os.makedirs("Ring_3/mods", exist_ok=True)
              with open("Ring_3/mods/index.html", "w") as f:
                  f.write(html_content)
          else:
              raise Exception(f"Failed to fetch contents: {response.status_code}, {response.text}")
          EOF

      - name: Commit Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add Ring_3/mods/index.html
          git commit -m "Update index.html in Ring_3/mods folder"
          git push

      - name: Release Lock
        run: |
          rm -f .github/LOCK
          git add .github/LOCK
          git commit -m "Release lock for Ring_3"
          git push
